<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€§æ ¼å¤§å†’éšª | Luna Engine ğŸŒ™</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            padding: 15px; overflow: hidden;
        }
        .container {
            background: white; border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px; width: 100%;
            padding: 30px 20px; position: relative;
            text-align: center;
        }
        .progress-bar {
            height: 6px; background: #eee; border-radius: 10px;
            margin-bottom: 25px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: #8A2BE2; width: 0%;
            transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .q-header { font-size: 14px; color: #888; margin-bottom: 10px; font-weight: bold; }
        .question-text {
            font-size: 24px; font-weight: 800; color: #333;
            margin-bottom: 30px; line-height: 1.4;
            min-height: 70px; display: flex; align-items: center; justify-content: center;
        }
        
        /* æ¨¡å¼ 1: å·¦å³å¤§æ–¹å¡Š */
        .options-grid { display: flex; gap: 15px; }
        .option-card {
            flex: 1; padding: 25px 15px; border: 3px solid #f0f0f0;
            border-radius: 20px; cursor: pointer;
            transition: all 0.2s ease;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            background: #fcfcfc;
        }
        .option-card:active { transform: scale(0.95); background: #f0f2ff; border-color: #8A2BE2; }
        .card-emoji { font-size: 64px; }
        .card-text { font-size: 18px; font-weight: 700; color: #444; }

        /* æ¨¡å¼ 2: æ»‘å¡Š Slider */
        .slider-container { display: none; padding: 20px 10px; }
        .range-slider {
            width: 100%; height: 15px; border-radius: 10px;
            background: #eee; outline: none; -webkit-appearance: none;
            margin: 30px 0;
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 35px; height: 35px;
            background: #8A2BE2; border-radius: 50%; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .slider-labels { display: flex; justify-content: space-between; font-weight: bold; color: #666; }
        .confirm-btn {
            margin-top: 20px; padding: 15px 40px; background: #8A2BE2;
            color: white; border: none; border-radius: 50px; font-weight: bold;
            cursor: pointer; display: inline-block;
        }

        /* å‹•ç•« */
        .fade-out { opacity: 0; transform: translateX(-20px); transition: 0.2s; }
        .fade-in { opacity: 1; transform: translateX(0); transition: 0.2s; }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
        <div class="q-header" id="q-counter">æº–å‚™é–‹å§‹...</div>
        <div class="question-text" id="q-text">Luna æ€§æ ¼å¤§å†’éšª</div>
        
        <!-- é»æ“Šæ¨¡å¼ -->
        <div class="options-grid" id="grid-mode">
            <div class="option-card" id="optA" onclick="handleSelect('A')">
                <div class="card-emoji" id="emojiA">ğŸš€</div>
                <div class="card-text" id="textA">åŠ è¼‰ä¸­</div>
            </div>
            <div class="option-card" id="optB" onclick="handleSelect('B')">
                <div class="card-emoji" id="emojiB">âœ¨</div>
                <div class="card-text" id="textB">åŠ è¼‰ä¸­</div>
            </div>
        </div>

        <!-- æ»‘å¡Šæ¨¡å¼ -->
        <div class="slider-container" id="slider-mode">
            <div class="slider-labels">
                <span id="labelLeft">å·¦</span>
                <span id="labelRight">å³</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="range-slider" id="slider">
            <button class="confirm-btn" onclick="handleSlider()">ç¢ºå®š ğŸ¯</button>
        </div>
    </div>

    <script>
        const coreQuestions = [
            { id: 1, type: 'grid', dim: 'EI', q: "æ”¶å·¥ä¹‹å¾Œï¼Œä½ é€šå¸¸æœƒé»æ¨£ã€Œå……é›»ã€ï¼Ÿ", A: "ç´„åŒäº‹å» Happy Hour ğŸº", AE: "ğŸº", B: "è‡ªå·±åŒ¿è¿”å±‹ä¼æ‰“æ©Ÿ/ç‡æ›¸ ğŸ®", BE: "ğŸ " },
            { id: 2, type: 'grid', dim: 'SN', q: "é¢å°ä¸€å€‹æ–° Projectï¼Œä½ æœƒå…ˆç‡ï¼š", A: "å…·é«”æ•¸æ“šåŒç¾æœ‰è³‡æº ğŸ“Š", AE: "ğŸ“Š", B: "æœªä¾†å˜…ç™¼å±•æ½›åŠ›åŒæ¦‚å¿µ ğŸ’¡", BE: "ğŸ”®" },
            { id: 3, type: 'slider', dim: 'TF', q: "æœ‹å‹åšéŒ¯å˜¢ä¿¾è€é—†é¬§ï¼Œä½ å˜…åæ‡‰ä¿‚ï¼š", left: "åˆ†æä½¢åšéŒ¯ä¹œ ğŸ§©", right: "å®‰æ…°ä½¢å˜…æ„Ÿå— â¤ï¸" },
            { id: 4, type: 'grid', dim: 'PJ', q: "æ˜ŸæœŸå…­æ—¥å˜…è¡Œç¨‹ï¼Œä½ é€šå¸¸ä¿‚ï¼š", A: "ä¸€æ—©å¯†å¯†éº»éº»ï¼Œè·Ÿè¶³è¨ˆåŠƒ ğŸ—“ï¸", AE: "ğŸ—“ï¸", B: "éš¨å¿ƒæ‰€æ¬²ï¼Œåˆ°æ™‚å…ˆç®— ğŸŒŠ", BE: "ğŸ’" },
            { id: 5, type: 'grid', dim: 'TRAP', q: "è€å¯¦è¬›ï¼Œä½ ä¿‚å’ªäº‚æ’³ç·Šç­”æ¡ˆï¼Ÿ", A: "æˆ‘ä¿‚èªçœŸå˜…ï¼ğŸ”¥", AE: "ğŸ”¥", B: "ä½ å¹æˆ‘å””è„¹ ğŸ¤ª", BE: "ğŸ¤ª" },
            { id: 6, type: 'slider', dim: 'EI', q: "å–ºå¤§æ’ç­µå¸­å˜… Party å…¥é¢ï¼š", left: "éœéœåœ°åä¸€é‚Š ğŸ§˜", right: "å…¨å ´èµ°è­˜æ–°æœ‹å‹ ğŸ¤" },
            { id: 7, type: 'grid', dim: 'SN', q: "ä½ æ¯”è¼ƒé¾æ„ç‡é‚Šé¡æ›¸/æˆ²ï¼Ÿ", A: "ç´€å¯¦ã€å‚³è¨˜ã€çœŸå¯¦æ•…äº‹ ğŸ“–", AE: "ğŸ“–", B: "ç§‘å¹»ã€å¥‡å¹»ã€æƒ³åƒåŠ›çˆ†ç™¼ ğŸ›¸", BE: "ğŸš€" },
            { id: 8, type: 'grid', dim: 'TF', q: "å·¥ä½œåˆ†æ­§æ™‚ï¼Œä½ æœ€æ€•é‚Šæ¨£ï¼Ÿ", A: "é€»è¾‘å””é€šï¼ŒåšéŒ¯æ±ºç­– âŒ", AE: "âš–ï¸", B: "å‚·å’—æ„Ÿæƒ…ï¼Œå¤§å®¶å””é–‹å¿ƒ ğŸ’”", BE: "ğŸ¤" },
            { id: 9, type: 'slider', dim: 'PJ', q: "ä½ å˜…æ›¸æ±é€šå¸¸ä¿‚é»æ¨£å˜…ï¼Ÿ", left: "äº‚ä¸­æœ‰åº ğŸ¨", right: "æ•´æ•´é½Šé½Š âœ¨" }
        ];

        const extraQuestions = {
            'EI': { type: 'grid', dim: 'EI', q: "ã€åŠ æ’é¡Œã€‘é‡åˆ°é›£é¡Œï¼Œä½ æœƒé»æµç­”æ¡ˆï¼Ÿ", A: "æµäººå‚¾ä¸‹æ”æ„è¦‹ ğŸ—£ï¸", AE: "ğŸ—£ï¸", B: "è‡ªå·±ä¸Šç¶²æµè³‡æ–™ ğŸ’»", BE: "ğŸ•µï¸" },
            'SN': { type: 'grid', dim: 'SN', q: "ã€åŠ æ’é¡Œã€‘è€é—†è¬›æœªä¾†è—åœ–ï¼Œä½ å¿ƒè«—ï¼š", A: "ä½¢ç•«ç·Šå¤§é¤…ï¼Ÿå¯¦éš›é»åšå…ˆï¼Ÿ ğŸ¤¨", AE: "ğŸ¤¨", B: "å¥½æ­£å–ï¼å¥½æœ‰é è¦‹ï¼ âœ¨", BE: "ğŸ¤©" },
            'TF': { type: 'grid', dim: 'TF', q: "ã€åŠ æ’é¡Œã€‘è§£åƒ±ä¸€å€‹è¡¨ç¾å·®ä½†å¥½è€å‹å˜…å“¡å·¥ï¼š", A: "ç‚ºå…¬å¸å¥½ï¼Œä¸€å®šè¦ç‚’ âš–ï¸", AE: "ğŸ’¼", B: "çœŸä¿‚å¥½é›£è½æ‰‹ï¼Œæƒ³å†ä¿¾æ©Ÿæœƒ ğŸ˜­", BE: "ğŸ¥º" },
            'PJ': { type: 'grid', dim: 'PJ', q: "ã€åŠ æ’é¡Œã€‘å¦‚æœè¦ä½ åŸ·å±‹ï¼Œä½ æœƒï¼š", A: "ä¸€æ¬¡éåŸ·æ™’æ‰€æœ‰å˜¢ ğŸ§¹", AE: "ğŸ§¹", B: "åŸ·åˆ°é‚Šç®—åˆ°é‚Š ğŸ“¦", BE: "ğŸ¤·" }
        };

        let currentIdx = 0;
        let scores = { E:0, I:0, S:0, N:0, T:0, F:0, P:0, J:0 };
        let results = [];
        let startTime = Date.now();
        let qStartTime = Date.now();
        let questionPool = [...coreQuestions];

        function updateUI() {
            const q = questionPool[currentIdx];
            const progress = (currentIdx / questionPool.length) * 100;
            document.getElementById('progress').style.width = progress + '%';
            document.getElementById('q-counter').innerText = `å•é¡Œ ${currentIdx + 1} / ${questionPool.length}`;
            
            const textEl = document.getElementById('q-text');
            textEl.classList.remove('fade-in');
            void textEl.offsetWidth; // trigger reflow
            textEl.classList.add('fade-in');
            textEl.innerText = q.q;

            if (q.type === 'grid') {
                document.getElementById('grid-mode').style.display = 'flex';
                document.getElementById('slider-mode').style.display = 'none';
                document.getElementById('emojiA').innerText = q.AE;
                document.getElementById('textA').innerText = q.A;
                document.getElementById('emojiB').innerText = q.BE;
                document.getElementById('textB').innerText = q.B;
            } else {
                document.getElementById('grid-mode').style.display = 'none';
                document.getElementById('slider-mode').style.display = 'block';
                document.getElementById('labelLeft').innerText = q.left;
                document.getElementById('labelRight').innerText = q.right;
                document.getElementById('slider').value = 50;
            }
            qStartTime = Date.now();
        }

        function handleSelect(choice) {
            const q = questionPool[currentIdx];
            const duration = Date.now() - qStartTime;
            
            if (q.dim !== 'TRAP') {
                const val = (choice === 'A') ? q.dim[0] : q.dim[1];
                scores[val] += 10; // Basic weight
            } else if (choice === 'B') {
                results.push({ trap: 'fail' });
            }

            results.push({ id: q.id, choice, duration });
            next();
        }

        function handleSlider() {
            const q = questionPool[currentIdx];
            const val = parseInt(document.getElementById('slider').value);
            const duration = Date.now() - qStartTime;
            
            // Weight based on slider position
            if (val < 50) {
                scores[q.dim[0]] += (50 - val) / 5;
            } else {
                scores[q.dim[1]] += (val - 50) / 5;
            }
            
            results.push({ id: q.id, val, duration });
            next();
        }

        function next() {
            currentIdx++;
            // Borderline detection logic after initial core
            if (currentIdx === 9) {
                const dims = ['EI', 'SN', 'TF', 'PJ'];
                dims.forEach(d => {
                    const s1 = scores[d[0]];
                    const s2 = scores[d[1]];
                    const total = s1 + s2;
                    if (total > 0) {
                        const ratio = s1 / total;
                        if (ratio > 0.4 && ratio < 0.6) {
                            questionPool.push(extraQuestions[d]);
                        }
                    }
                });
            }

            if (currentIdx < questionPool.length) {
                updateUI();
            } else {
                finish();
            }
        }

        function finish() {
            const finalScores = {
                EI: Math.round((scores.E / (scores.E + scores.I || 1)) * 100),
                SN: Math.round((scores.S / (scores.S + scores.N || 1)) * 100),
                TF: Math.round((scores.T / (scores.T + scores.F || 1)) * 100),
                PJ: Math.round((scores.P / (scores.P + scores.J || 1)) * 100)
            };
            const type = (finalScores.EI >= 50 ? 'E':'I') + (finalScores.SN >= 50 ? 'S':'N') + (finalScores.TF >= 50 ? 'T':'F') + (finalScores.PJ >= 50 ? 'P':'J');
            
            localStorage.setItem('luna_mbti_result', JSON.stringify({
                type,
                scores: finalScores,
                time: Math.round((Date.now() - startTime) / 1000),
                traps: results.filter(r => r.trap === 'fail').length
            }));
            
            window.location.href = 'mbti_result.html';
        }

        updateUI();
    </script>
</body>
</html>